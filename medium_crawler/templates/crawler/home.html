{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Medium Crawler - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Hero Section -->
        <div class="jumbotron bg-primary text-white rounded p-5 mb-5">
            <div class="text-center">
                <h1 class="display-4"><i class="fas fa-spider"></i> Medium Crawler</h1>
                <p class="lead">Discover and crawl the latest Medium articles by tags</p>
                <p class="mb-0">Enter a tag below to start crawling Medium.com articles in real-time!</p>
            </div>
        </div>

        <!-- Search Form -->
        <div class="card shadow mb-5">
            <div class="card-header bg-white">
                <h3 class="card-title mb-0">
                    <i class="fas fa-search"></i> Search Articles by Tag
                </h3>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'crawler:search_tag' %}" id="search-form">
                    {% csrf_token %}
                    {% crispy form %}
                </form>
                
                <!-- Tag Suggestions -->
                <div id="tag-suggestions" class="mt-3" style="display: none;">
                    <h6>Suggested Tags:</h6>
                    <div id="suggestions-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Blogs -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-clock"></i> Recently Crawled Blogs
                </h4>
            </div>
            <div class="card-body">
                {% if recent_blogs %}
                    <div class="row">
                        {% for blog in recent_blogs %}
                        <div class="col-md-6 mb-4">
                            <div class="card blog-card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="{% url 'crawler:blog_detail' blog.id %}" class="text-decoration-none">
                                            {{ blog.title|truncatechars:60 }}
                                        </a>
                                    </h6>
                                    <p class="card-text text-muted small">
                                        <i class="fas fa-user"></i> {{ blog.author.name }}
                                        {% if blog.reading_time %}
                                            | <i class="fas fa-clock"></i> {{ blog.reading_time }}
                                        {% endif %}
                                    </p>
                                    <p class="card-text">
                                        {{ blog.content|truncatechars:100 }}
                                    </p>
                                    <div class="mb-2">
                                        {% for tag in blog.tags.all|slice:":3" %}
                                            <span class="badge bg-secondary tag-badge">{{ tag.name }}</span>
                                        {% endfor %}
                                    </div>
                                    <small class="text-muted">
                                        Crawled {{ blog.crawled_at|timesince }} ago
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center">
                        <a href="{% url 'crawler:blog_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-right"></i> View All Blogs
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search text-muted fa-3x mb-3"></i>
                        <h5 class="text-muted">No blogs crawled yet</h5>
                        <p class="text-muted">Start by searching for a tag above!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search History Sidebar -->
    <div class="col-lg-4">
        <div class="card shadow">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history"></i> Recent Searches
                </h5>
            </div>
            <div class="card-body">
                {% if search_history %}
                    {% for search in search_history %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                        <div>
                            <strong>{{ search.tag_searched }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ search.results_count }} results in {{ search.crawl_duration|floatformat:1 }}s
                            </small>
                        </div>
                        <small class="text-muted">
                            {{ search.search_time|timesince }} ago
                        </small>
                    </div>
                    {% endfor %}
                    <div class="text-center">
                        <a href="{% url 'crawler:search_history' %}" class="btn btn-sm btn-outline-secondary">
                            View All History
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p>No search history yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Popular Tags -->
        <div class="card shadow mt-4">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tags"></i> Quick Start Tags
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap">
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="programming">programming</button>
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="python">python</button>
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="javascript">javascript</button>
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="startup">startup</button>
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="technology">technology</button>
                    <button class="btn btn-outline-primary btn-sm m-1 quick-tag-btn" data-tag="data-science">data-science</button>
                </div>
                <small class="text-muted mt-2 d-block">
                    Click on any tag above to quickly start crawling
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Tag auto-suggestions
    let suggestionTimeout;
    
    $('#tag-input').on('input', function() {
        clearTimeout(suggestionTimeout);
        const query = $(this).val();
        
        if (query.length >= 2) {
            suggestionTimeout = setTimeout(function() {
                $.get('{% url "crawler:tag_suggestions_api" %}', { q: query }, function(data) {
                    if (data.suggestions.length > 0) {
                        let suggestionsHtml = '';
                        data.suggestions.forEach(function(tag) {
                            suggestionsHtml += `<button type="button" class="btn btn-sm btn-outline-info me-1 mb-1 suggestion-btn" data-tag="${tag}">${tag}</button>`;
                        });
                        $('#suggestions-container').html(suggestionsHtml);
                        $('#tag-suggestions').show();
                    } else {
                        $('#tag-suggestions').hide();
                    }
                });
            }, 300);
        } else {
            $('#tag-suggestions').hide();
        }
    });
    
    // Handle suggestion clicks
    $(document).on('click', '.suggestion-btn, .quick-tag-btn', function() {
        const tag = $(this).data('tag');
        $('#tag-input').val(tag);
        $('#tag-suggestions').hide();
    });
    
    // Form submission with loading state
    $('#search-form').on('submit', function() {
        const submitBtn = $(this).find('input[type="submit"]');
        submitBtn.prop('disabled', true).val('Starting Crawl...');
        
        // Re-enable after 3 seconds in case of issues
        setTimeout(function() {
            submitBtn.prop('disabled', false).val('Start Crawling');
        }, 3000);
    });
});
</script>
{% endblock %}